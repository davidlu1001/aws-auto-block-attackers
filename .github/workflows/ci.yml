name: CI/CD Pipeline

on:
    push:
        branches: [main, master, develop]
    pull_request:
        branches: [main, master]
    workflow_dispatch:

jobs:
    lint:
        name: Code Quality & Linting
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version:
                    ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "uv.lock"

            - name: Set up Python ${{ matrix.python-version }}
              run: uv python install ${{ matrix.python-version }}

            - name: Install dependencies
              run: |
                  uv sync --all-extras
                  uv pip install black pylint mypy bandit safety

            - name: Check code formatting with Black
              run: |
                  uv run black --check --diff --line-length 100 .
              continue-on-error: true

            - name: Lint with Pylint
              run: |
                  uv run pylint auto_block_attackers.py slack_client.py --max-line-length=100 --fail-under=7.0
              continue-on-error: true

            - name: Type check with MyPy
              run: |
                  uv run mypy auto_block_attackers.py slack_client.py --ignore-missing-imports
              continue-on-error: true

            - name: Security scan with Bandit
              run: |
                  uv run bandit -r . -f json -o bandit-report.json || true
                  uv run bandit -r . -ll

    test:
        name: Run Tests
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.8", "3.12", "3.14"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "uv.lock"

            - name: Set up Python ${{ matrix.python-version }}
              run: uv python install ${{ matrix.python-version }}

            - name: Install dependencies with uv
              run: |
                  uv sync --all-extras
                  uv pip install pytest pytest-cov pytest-mock moto

            - name: Run unit tests
              run: |
                  uv run pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing
              continue-on-error: true

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-${{ matrix.python-version }}
                  fail_ci_if_error: false
              continue-on-error: true

    security-scan:
        name: Security Vulnerability Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "uv.lock"

            - name: Set up Python
              run: uv python install 3.14

            - name: Install dependencies with uv
              run: |
                  uv sync
                  uv pip install safety bandit

            - name: Check for known vulnerabilities with Safety
              run: |
                  uv run safety check --json || true
              continue-on-error: true

            - name: Security linting with Bandit
              run: |
                  uv run bandit -r . -f screen -ll
              continue-on-error: true

    validate-examples:
        name: Validate Example Files
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Validate YAML files
              run: |
                  sudo apt-get update && sudo apt-get install -y yamllint
                  yamllint examples/config.example.yaml .github/workflows/ci.yml || true
              continue-on-error: true

            - name: Check systemd service file syntax
              run: |
                  if [ -f examples/systemd-example.service ]; then
                    echo " Systemd service file exists"
                    grep -q "ExecStart" examples/systemd-example.service && echo " ExecStart found" || echo " ExecStart missing"
                  fi

            - name: Validate file structure
              run: |
                  echo "Checking required files..."
                  required_files=(
                    "README.md"
                    "LICENSE"
                    "CONTRIBUTING.md"
                    "SECURITY.md"
                    "pyproject.toml"
                    "auto_block_attackers.py"
                    "slack_client.py"
                  )

                  for file in "${required_files[@]}"; do
                    if [ -f "$file" ]; then
                      echo " $file exists"
                    else
                      echo " $file is missing"
                      exit 1
                    fi
                  done

    dry-run-test:
        name: Dry Run Syntax Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "uv.lock"

            - name: Set up Python
              run: uv python install 3.12

            - name: Install dependencies with uv
              run: uv sync

            - name: Python syntax check
              run: |
                  uv run python -m py_compile auto_block_attackers.py
                  uv run python -m py_compile slack_client.py

            - name: Check script help output
              run: |
                  uv run python auto_block_attackers.py --help

    build:
        name: Build Package
        runs-on: ubuntu-latest
        needs: [lint, test]
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "uv.lock"

            - name: Set up Python
              run: uv python install 3.12

            - name: Build package with uv
              run: |
                  uv build

            - name: Check package with twine
              run: |
                  uv pip install twine
                  uv run twine check dist/*

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/
                  retention-days: 30

    # Uncomment when ready to publish to PyPI
    # publish:
    #   name: Publish to PyPI
    #   runs-on: ubuntu-latest
    #   needs: [build]
    #   if: startsWith(github.ref, 'refs/tags/v')
    #
    #   steps:
    #   - name: Checkout code
    #     uses: actions/checkout@v4
    #
    #   - name: Install uv
    #     uses: astral-sh/setup-uv@v3
    #
    #   - name: Set up Python
    #     run: uv python install 3.12
    #
    #   - name: Download artifacts
    #     uses: actions/download-artifact@v4
    #     with:
    #       name: dist
    #       path: dist/
    #
    #   - name: Publish to PyPI with uv
    #     run: |
    #       uv pip install twine
    #       uv run twine upload dist/* --username __token__ --password ${{ secrets.PYPI_API_TOKEN }}
